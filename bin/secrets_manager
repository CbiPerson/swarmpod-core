#!/usr/bin/env ruby
#
# secrets_manager - List and set SwarmPod secrets
#
# Usage:
#   secrets_manager              # list all secrets (default)
#   secrets_manager list         # list all secrets
#   secrets_manager set KEY value
#

require_relative "paths"

def ok(msg)   = puts("  [OK]   #{msg}")
def fail!(msg) = puts("  [FAIL] #{msg}")
def info(msg)  = puts("         #{msg}")

def mask(value)
  return "(empty)" if value.nil? || value.strip.empty?
  v = value.strip
  v.length <= 8 ? "*" * v.length : "#{v[0..3]}#{"*" * [v.length - 4, 4].max}"
end

def each_secret(dir, &block)
  Dir.glob(File.join(dir, "**", "*.sh")).sort.each do |path|
    File.readlines(path).each do |line|
      if (m = line.match(/\Aexport\s+(\w+)=["']?(.+?)["']?\s*\z/))
        block.call(m[1], m[2], path)
      end
    end
  end
end

def find_secret_file(dir, key)
  Dir.glob(File.join(dir, "**", "*.sh")).sort.each do |path|
    File.readlines(path).each do |line|
      return path if line.match?(/\Aexport\s+#{Regexp.escape(key)}=/)
    end
  end
  nil
end

# ── list ────────────────────────────────────────────────────────

def cmd_list(dir)
  unless Dir.exist?(dir)
    fail! "Secrets directory not found: #{dir}"
    exit 1
  end

  count = 0
  each_secret(dir) do |key, value, path|
    rel = path.sub("#{dir}/", "")
    info "#{key}=#{mask(value)}  (#{rel})"
    count += 1
  end

  if count == 0
    info "No secrets found in #{dir}"
  else
    puts
    ok "#{count} secret(s) found in #{dir}"
  end
end

# ── set ─────────────────────────────────────────────────────────

def cmd_set(dir, key, value)
  unless key && value
    fail! "Usage: secrets_manager set KEY value"
    exit 1
  end

  unless key.match?(/\A[A-Z_][A-Z0-9_]*\z/)
    fail! "Key must be uppercase with underscores (e.g. ANTHROPIC_API_KEY)"
    exit 1
  end

  FileUtils.mkdir_p(dir) unless Dir.exist?(dir)

  existing = find_secret_file(dir, key)
  line = "export #{key}=#{value}\n"

  if existing
    contents = File.read(existing)
    updated = contents.gsub(/^export\s+#{Regexp.escape(key)}=.*$/, "export #{key}=#{value}")
    File.write(existing, updated)
    ok "Updated #{key} in #{existing.sub("#{dir}/", "")}"
  else
    path = File.join(dir, "#{key}.sh")
    File.write(path, line)
    ok "Created #{path.sub("#{dir}/", "")}"
  end
end

# ── main ────────────────────────────────────────────────────────

require "fileutils"

command = ARGV[0] || "list"

case command
when "list"
  cmd_list(SECRETS_DIR)
when "set"
  cmd_set(SECRETS_DIR, ARGV[1], ARGV[2])
else
  fail! "Unknown command: #{command}"
  info "Usage: secrets_manager [list | set KEY value]"
  exit 1
end
