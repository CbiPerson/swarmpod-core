#!/usr/bin/env ruby
#
# verify_anthropic_connection - Verify Anthropic API key and list available models
#

require "net/http"
require "uri"
require "json"
require "openssl"

require_relative "paths"

def ok(msg)   = puts("  [OK]   #{msg}")
def fail!(msg) = puts("  [FAIL] #{msg}")
def info(msg)  = puts("         #{msg}")

def discover_secret(env_var, file_path)
  value = ENV[env_var]
  return value if value && !value.empty?
  if File.exist?(file_path)
    match = File.read(file_path).match(/export\s+#{Regexp.escape(env_var)}=(.+)/)
    return match[1].strip if match
  end
  nil
end

begin

key_file = File.join(SECRETS_DIR, "anthropic", "ANTHROPIC_API_KEY.sh")
api_key = discover_secret("ANTHROPIC_API_KEY", key_file)

unless api_key
  fail! "Cannot find ANTHROPIC_API_KEY in env or #{key_file}"
  exit 1
end

ok "Found ANTHROPIC_API_KEY"
info "Key starts with: #{api_key[0..15]}..."

# Test key by listing models
uri = URI("https://api.anthropic.com/v1/models")
http = Net::HTTP.new(uri.host, uri.port)
http.use_ssl = true
http.open_timeout = 10
http.read_timeout = 15
store = OpenSSL::X509::Store.new
store.set_default_paths
http.cert_store = store
http.verify_mode = OpenSSL::SSL::VERIFY_PEER

request = Net::HTTP::Get.new(uri)
request["x-api-key"]         = api_key
request["anthropic-version"] = "2023-06-01"

response = http.request(request)
code = response.code.to_i
data = JSON.parse(response.body) rescue {}

case code
when 200
  ok "Anthropic API authenticated successfully"
  models = data["data"] || []
  info "Available models:"
  models.each { |m| info "  - #{m["display_name"]} (#{m["id"]})" }
else
  fail! "HTTP #{code}: #{data.dig("error", "message") || response.body[0..200]}"
  exit 1
end

rescue SocketError, Errno::ECONNREFUSED, Net::OpenTimeout => e
  fail! "Network error: #{e.message}"
  exit 1
end
