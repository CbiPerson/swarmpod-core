#!/usr/bin/env ruby
#
# verify_hostinger_connection - Verify Hostinger VPS credentials and connectivity
#

require "socket"

require_relative "paths"

def ok(msg)   = puts("  [OK]   #{msg}")
def fail!(msg) = puts("  [FAIL] #{msg}")
def info(msg)  = puts("         #{msg}")

def discover_secret(env_var, file_path)
  value = ENV[env_var]
  return value if value && !value.empty?
  if File.exist?(file_path)
    match = File.read(file_path).match(/export\s+#{Regexp.escape(env_var)}=(.+)/)
    return match[1].strip if match
  end
  nil
end

# ── Read credentials ──────────────────────────────────────────

deploy_dir    = File.join(SECRETS_DIR, "deployment", "Hostinger")
account_file  = File.join(deploy_dir, "HOSTINGER_ACCOUNT.sh")
password_file = File.join(deploy_dir, "HOSTINGER_PASSWORD.sh")
server_file   = File.join(deploy_dir, "HOSTINGER_SERVER.sh")

account  = discover_secret("HOSTINGER_ACCOUNT", account_file)
password = discover_secret("HOSTINGER_PASSWORD", password_file)
server   = discover_secret("HOSTINGER_VPS", server_file)

unless account
  fail! "Cannot find HOSTINGER_ACCOUNT"
  exit 1
end
ok "Found HOSTINGER_ACCOUNT: #{account}"

unless password
  fail! "Cannot find HOSTINGER_PASSWORD"
  exit 1
end
ok "Found HOSTINGER_PASSWORD"

unless server
  fail! "Cannot find HOSTINGER_VPS"
  exit 1
end
ok "Found HOSTINGER_VPS: #{server}"

# ── DNS resolution ────────────────────────────────────────────

info "Resolving #{server}..."

begin
  addresses = Addrinfo.getaddrinfo(server, nil)
  ipv4 = addresses.find { |a| a.ipv4? }&.ip_address
  ipv6 = addresses.find { |a| a.ipv6? }&.ip_address
  ok "DNS resolves"
  info "  IPv4: #{ipv4}" if ipv4
  info "  IPv6: #{ipv6}" if ipv6
rescue SocketError => e
  fail! "DNS resolution failed: #{e.message}"
  exit 1
end

# ── Port checks ───────────────────────────────────────────────

{22 => "SSH", 80 => "HTTP", 443 => "HTTPS"}.each do |port, label|
  begin
    Socket.tcp(server, port, connect_timeout: 5) { |s| s.close }
    ok "#{label} (port #{port}): open"
  rescue Errno::ECONNREFUSED
    info "#{label} (port #{port}): closed"
  rescue Errno::ETIMEDOUT, SocketError => e
    info "#{label} (port #{port}): unreachable (#{e.class.name.split("::").last})"
  end
end

info ""
info "To test SSH login:"
info "  ssh #{account}@#{server}"
